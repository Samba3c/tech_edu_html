<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¿·ä½ å°ç•«å®¶</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      background-color: #f0f0f0; /* é€™è£¡è¨­å®šèƒŒæ™¯é¡è‰² */
    }
    #tools {
      position: fixed;
      left: 0;
      top: 0;
      width: 250px;
      height: 100vh;
      background: #add8e6; /* ä¿®æ”¹é€™è£¡çš„é¡è‰² */
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    canvas {
      margin-left: 300px;
      margin-top: 10px;
	  margin-bottom: 10px; /* å¢åŠ åº•éƒ¨ç©ºç™½ */
      border: 1px solid #000;
    }
    button, input[type="file"] {
      padding: 10px;
      font-size: 24px;
      width: 100%;
    }
    .active {
      background-color: #ffa500 !important;
    }
    #title-btn {
      font-size: 32px;
      font-weight: bold;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    label {
      font-size: 24px; /* ä¿®æ”¹é€™è£¡çš„å­—é«”å¤§å° */
    }
    select, option {
      font-size: 24px; /* ä¿®æ”¹é€™è£¡çš„å­—é«”å¤§å° */
    }
    #color-picker {
      height: 50px; /* èª¿æ•´é«˜åº¦ */
      font-size: 24px; /* èª¿æ•´å­—é«”å¤§å° */
      padding: 5px; /* å¢åŠ å…§é‚Šè· */
      width: 100%; /* ç¢ºä¿ä½”æ»¿å¯¬åº¦ */
    }

    /* æ–°å¢æ¨£å¼ä¾†è¨­ç½®æ°´å¹³ç·šçš„å¤–è§€ */
    hr {
      width: 80%; /* è®“æ°´å¹³ç·šåªä½”å·¥å…·æ¬„çš„ä¸€éƒ¨åˆ† */
      border: 1px solid #000; /* è¨­ç½®é‚Šæ¡†é¡è‰² */
      margin: 10px 0; /* è¨­ç½®ä¸Šä¸‹é–“è· */
    }
  </style>
</head>
<body>
  <div id="tools">
    <!-- æ–°å¢æ¨™é¡ŒæŒ‰éˆ• -->
    <button id="title-btn">ğŸ¨ï¸ è¿·ä½ å°ç•«å®¶</button>
    <!-- å…¶ä»–å·¥å…·æŒ‰éˆ• -->
    <input type="file" id="upload-image" />
    <button id="undo-btn">â†©ï¸ è¿”å›</button>
    <button id="redo-btn">â†ªï¸ é‡åš</button>
    <select id="brush-shape">
      <option value="round">âœ’ï¸ç•«ç­†å½¢ç‹€ï¼šåœ“å½¢</option>
      <option value="square">âœ’ï¸ç•«ç­†å½¢ç‹€ï¼šæ­£æ–¹å½¢</option>
    </select>

    <label for="brush-size">ğŸ–Œï¸ ç•«ç­†å¤§å°:</label>
    <input type="range" id="brush-size" min="1" max="10" value="5">
    <input type="color" id="color-picker" value="#000000">

    <button id="fill-btn">ğŸ–ï¸ æ²¹æ¼†æ¡¶å¡«è‰²</button>
    <button id="clear-btn">âŒ æ¸…é™¤ç•«å¸ƒ</button>
    <button id="save-btn">ğŸ’¾ ä¸‹è¼‰å­˜æª”</button>
    <!-- æ–°å¢æ°´å¹³ç·š -->
    <hr />
    <button id="title-auther">ç¨‹å¼ä½œè€…ï¼šé˜¿é‚¦è€å¸«</button>

  </div>

  <canvas id="drawing-canvas" width="1024" height="768"></canvas>

  <script>
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    const brushSize = document.getElementById('brush-size');
    const brushShape = document.getElementById('brush-shape');
    const clearBtn = document.getElementById('clear-btn');
    const fillBtn = document.getElementById('fill-btn');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    const saveBtn = document.getElementById('save-btn');
    const colorPicker = document.getElementById('color-picker');
    const uploadImage = document.getElementById('upload-image');
    const titleBtn = document.getElementById('title-btn');
    const titleAutherBtn = document.getElementById('title-auther');  // é€™è£¡æ˜¯ç¨‹å¼ä½œè€…æŒ‰éˆ•çš„å¼•ç”¨

    let painting = false;
    let currentColor = "#000000";
    let filling = false;
    let history = [];
    let redoHistory = [];
    let uploadedImage = null;
    
    const MAX_HISTORY = 5; // è¨­å®šæ­·å²ç´€éŒ„çš„æœ€å¤§æ¬¡æ•¸

    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    function saveState() {
      // é™åˆ¶æ­·å²ç´€éŒ„æœ€å¤šä¿å­˜ MAX_HISTORY æ¬¡
      if (history.length >= MAX_HISTORY) {
        history.shift(); // ç§»é™¤æœ€èˆŠçš„ç´€éŒ„
      }
      redoHistory = [];
      history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    }

    colorPicker.addEventListener('input', (e) => {
      currentColor = e.target.value;
      ctx.strokeStyle = currentColor;
      ctx.fillStyle = currentColor;
    });

    canvas.addEventListener('mousedown', (e) => {
      saveState();
      if (filling) {
        fillCanvas(e.offsetX, e.offsetY);
      } else {
        painting = true;
        ctx.beginPath();
      }
    });

    canvas.addEventListener('mouseup', () => {
      painting = false;
      ctx.beginPath();
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!painting) return;
      ctx.lineWidth = brushSize.value;
      ctx.lineCap = brushShape.value;
      ctx.strokeStyle = currentColor;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    clearBtn.addEventListener('click', () => {
      saveState();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    });

    fillBtn.addEventListener('click', () => {
      filling = !filling;
      fillBtn.classList.toggle('active', filling);
      fillBtn.textContent = filling ? 'åœæ­¢å¡«è‰²' : 'æ²¹æ¼†æ¡¶å¡«è‰²';
    });

    undoBtn.addEventListener('click', () => {
      if (history.length > 0) {
        redoHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        const lastState = history.pop();
        ctx.putImageData(lastState, 0, 0);
      }
    });

    redoBtn.addEventListener('click', () => {
      if (redoHistory.length > 0) {
        const redoState = redoHistory.pop();
        history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        ctx.putImageData(redoState, 0, 0);
      }
    });

    saveBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = 'ç­ç´šåº§è™Ÿ.png';
      link.click();
    });

    function fillCanvas(x, y) {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;
      const targetIndex = (y * canvas.width + x) * 4;
      const targetColor = [pixels[targetIndex], pixels[targetIndex + 1], pixels[targetIndex + 2], pixels[targetIndex + 3]];
      const fillColor = hexToRgb(currentColor);
      if (colorsMatch(targetColor, fillColor)) return;
      
      const stack = [[x, y]];
      while (stack.length) {
        const [cx, cy] = stack.pop();
        const index = (cy * canvas.width + cx) * 4;
        if (!colorsMatch([pixels[index], pixels[index+1], pixels[index+2], pixels[index+3]], targetColor)) continue;
        pixels[index] = fillColor.r;
        pixels[index + 1] = fillColor.g;
        pixels[index + 2] = fillColor.b;
        pixels[index + 3] = 255;
        if (cx > 0) stack.push([cx - 1, cy]);
        if (cx < canvas.width - 1) stack.push([cx + 1, cy]);
        if (cy > 0) stack.push([cx, cy - 1]);
        if (cy < canvas.height - 1) stack.push([cx, cy + 1]);
      }
      ctx.putImageData(imageData, 0, 0);
    }

    function hexToRgb(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return { r, g, b };
    }

    function colorsMatch(color1, color2) {
      return color1[0] === color2[0] && color1[1] === color2[1] && color1[2] === color2[2] && color1[3] === color2[3];
    }

    // ä¸Šå‚³åœ–ç‰‡ä¸¦é¡¯ç¤º
    uploadImage.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          uploadedImage = img;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // ç•¶é»æ“Š"ç¨‹å¼ä½œè€…"æŒ‰éˆ•æ™‚é¡¯ç¤º alert è¦–çª—
    titleAutherBtn.addEventListener('click', () => {
      alert("é€™é¡†æŒ‰éˆ•æœƒå¬å–šğŸ§™â€â™‚ï¸é˜¿é‚¦è€å¸«ï¼Œ\nåƒè¬ä¸èƒ½äº‚æŒ‰ï¼ï¼");
    });
  </script>
</body>
</html>
